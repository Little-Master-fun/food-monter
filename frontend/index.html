<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>食物监控 - Food Monitor</title>
    <style>
      @font-face {
        font-family: "ZhanKuKuaiLeTi";
        src: url("./font/ZhanKuKuaiLeTi2016XiuDingBan-1.ttf") format("truetype");
        font-weight: normal;
        font-style: normal;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(135deg, #fffed7 0%, #fcfac9 100%);
        min-height: 100vh;
        padding: 0;
      }

      .container {
        max-width: 100%;
        height: 100vh;
        overflow-y: auto;
      }

      /* 内容居中容器 */
      .content-wrapper {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 30px;
        background: #fffed7;
      }

      .header-content {
        max-width: 1200px;
        width: 100%;
        margin: 0 auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 1.8rem;
        color: #333;
        font-weight: 600;
        font-family: "ZhanKuKuaiLeTi", -apple-system, BlinkMacSystemFont,
          "Segoe UI", Roboto, sans-serif;
      }

      .menu-icon {
        font-size: 1.5rem;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .menu-icon span {
        width: 25px;
        height: 3px;
        background: #333;
        border-radius: 2px;
      }

      /* 主内容区 */
      .main-content {
        padding: 20px 30px;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* 桌面端布局 */
      .desktop-layout {
        display: grid;
        grid-template-columns: 1fr;
        gap: 25px;
      }

      @media (min-width: 1024px) {
        .desktop-layout {
          grid-template-columns: 400px 1fr;
        }

        .calendar-section {
          grid-row: 1 / 3;
        }

        .meals-section {
          grid-column: 2;
        }

        .nutrition-section {
          grid-column: 2;
        }
      }

      /* 日历区域 */
      .calendar-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .calendar-header {
        text-align: center;
        margin-bottom: 20px;
        color: #666;
        font-size: 0.9rem;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
        margin-bottom: 15px;
      }

      .calendar-day-header {
        text-align: center;
        font-size: 0.85rem;
        color: #999;
        padding: 8px 0;
      }

      .calendar-days-container {
        max-height: 50px;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .calendar-days-container.expanded {
        max-height: 400px;
      }

      .calendar-day {
        aspect-ratio: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        cursor: pointer;
        font-size: 0.9rem;
        color: #333;
        transition: all 0.2s;
      }

      .calendar-day:hover {
        background: #f0f0f0;
      }

      .calendar-day.today {
        background: #2d5a3d;
        color: white;
        font-weight: bold;
      }

      .calendar-day.disabled {
        color: #ddd;
        cursor: default;
      }

      .calendar-day.disabled:hover {
        background: transparent;
      }

      /* 今日目录 */
      .today-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
      }

      .meals-container {
        width: calc(100vw - 40px);
        overflow-x: auto;
        overflow-y: hidden;
        margin-bottom: 25px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        -ms-overflow-style: none;
      }

      .meals-container::-webkit-scrollbar {
        display: none;
      }

      .meals-grid {
        display: flex;
        gap: 15px;
        padding-bottom: 10px;
        width: max-content;
        min-width: 100%;
      }

      @media (min-width: 768px) {
        .meals-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
          gap: 20px;
          width: 100%;
          min-width: auto;
        }

        .meals-container {
          overflow-x: visible;
        }
      }

      @media (min-width: 1024px) {
        .meals-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .meal-card {
        background: #f5f5f5;
        border-radius: 15px;
        min-height: 250px;
        min-width: 180px;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 0;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .meal-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .meal-card.has-image {
        background: #40672b;
      }

      .meal-card-image {
        flex: 1;
        background-size: cover;
        background-position: center;
        border-radius: 15px;
        min-height: 120px;
      }

      .meal-time {
        font-size: 0.7rem;
        color: white;
        background: #40672b;
        padding: 10px 15px;
        text-align: center;
      }

      .meal-card:not(.has-image) .meal-time {
        background: #f5f5f5;
        color: #999;
        display: flex;
        align-items: center;
        justify-content: center;
        flex: 1;
      }

      /* 营养概览 */
      .nutrition-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .nutrition-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-around;
        height: 200px;
        margin: 20px 0;
      }

      .nutrition-bar {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        flex: 1;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .nutrition-bar:hover {
        transform: scale(1.05);
      }

      .bar-container {
        width: 60%;
        height: 180px;
        display: flex;
        align-items: flex-end;
        background-color: #ffec668f;
        border-radius: 50px;
      }

      /* 营养详情气泡 */
      .nutrition-tooltip {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%) translateY(-10px);
        background: white;
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        min-width: 160px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        z-index: 100;
        pointer-events: none;
      }

      .nutrition-tooltip.show {
        opacity: 1;
        visibility: visible;
        transform: translateX(-50%) translateY(-5px);
      }

      .nutrition-tooltip::after {
        content: "";
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 8px solid transparent;
        border-top-color: white;
      }

      .tooltip-title {
        font-weight: 600;
        color: #2d5a3d;
        margin-bottom: 10px;
        font-size: 0.9rem;
      }

      .tooltip-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 6px;
        font-size: 0.8rem;
        color: #666;
      }

      .tooltip-value {
        font-weight: 600;
        color: #333;
      }

      .tooltip-percentage {
        margin-top: 8px;
        padding-top: 8px;
        border-top: 1px solid #f0f0f0;
        text-align: center;
        font-size: 0.85rem;
        color: #2d5a3d;
        font-weight: 600;
      }

      .bar {
        width: 100%;
        background: #2d5a3d;
        border-radius: 50px;
        transition: height 0.5s ease;
      }

      .bar.light {
        background: #e8ecd4;
      }

      .bar-label {
        font-size: 0.8rem;
        color: #666;
        text-align: center;
      }

      /* 推荐食物 */
      .recommendations-section {
        background: white;
        border-radius: 20px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .food-table {
        width: 100%;
        border-collapse: collapse;
      }

      .food-table thead {
        background: #f9f9f9;
      }

      .food-table th {
        padding: 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
        color: #666;
        border-bottom: 2px solid #f0f0f0;
      }

      .food-table td {
        padding: 15px 12px;
        border-bottom: 1px solid #f5f5f5;
        font-size: 0.9rem;
        color: #333;
      }

      .food-table tr:last-child td {
        border-bottom: none;
      }

      /* 食物详情模态框 */
      .food-detail-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        padding: 10px;
      }

      .food-detail-modal.show {
        display: flex;
      }

      .food-detail-content {
        background: white;
        border-radius: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          opacity: 0;
          transform: translateY(50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .food-detail-close {
        position: absolute;
        top: 15px;
        right: 15px;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: #666;
        z-index: 10;
        transition: all 0.2s;
      }

      .food-detail-close:hover {
        background: rgba(0, 0, 0, 0.2);
        transform: rotate(90deg);
      }

      .food-detail-image {
        width: 100%;
        height: 250px;
        background-size: cover;
        background-position: center;
        border-radius: 20px 20px 0 0;
      }

      .food-detail-body {
        padding: 25px;
      }

      .food-detail-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: #2d5a3d;
        margin-bottom: 10px;
      }

      .food-detail-time {
        font-size: 0.85rem;
        color: #999;
        margin-bottom: 15px;
      }

      .food-detail-description {
        font-size: 0.95rem;
        color: #666;
        line-height: 1.6;
        margin-bottom: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 10px;
      }

      .food-detail-section {
        margin-bottom: 20px;
      }

      .food-detail-section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nutrition-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .nutrition-item {
        background: #f9f9f9;
        padding: 15px;
        border-radius: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nutrition-label {
        font-size: 0.9rem;
        color: #666;
      }

      .nutrition-value {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2d5a3d;
      }

      .weight-info {
        background: linear-gradient(135deg, #40672b 0%, #2d5a3d 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
        margin-bottom: 20px;
      }

      .weight-value {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 5px;
      }

      .weight-label {
        font-size: 0.85rem;
        opacity: 0.9;
      }

      .vitamins-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .vitamin-tag {
        background: #e8ecd4;
        color: #2d5a3d;
        padding: 6px 12px;
        border-radius: 15px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .header h1 {
          font-size: 1.5rem;
        }

        .main-content {
          padding: 15px 20px;
        }

        .nutrition-grid {
          grid-template-columns: 1fr;
        }

        .food-detail-content {
          margin: 10px;
        }

        .meal-card {
          min-width: 180px;
        }
      }

      /* 桌面端优化 */
      @media (min-width: 1024px) {
        .header h1 {
          font-size: 2.2rem;
        }

        .main-content {
          padding: 30px 40px;
        }

        .calendar-section {
          position: sticky;
          top: 20px;
          align-self: start;
        }

        .meal-card {
          min-width: auto;
          width: 100%;
        }

        .nutrition-chart {
          height: 250px;
        }

        .bar-container {
          height: 220px;
        }

        .food-detail-content {
          max-width: 600px;
        }

        .nutrition-grid {
          grid-template-columns: repeat(3, 1fr);
        }
      }

      @media (min-width: 1440px) {
        .main-content {
          max-width: 1400px;
        }

        .header-content {
          max-width: 1400px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- 顶部标题 -->
      <div class="header">
        <div class="header-content">
          <h1>Hi, <span id="userName">毕钰</span></h1>
          <!-- <div class="menu-icon">
            <span></span>
            <span></span>
            <span></span>
          </div> -->
        </div>
      </div>

      <!-- 主内容区 -->
      <div class="main-content">
        <div class="desktop-layout">
          <!-- 日历 -->
          <div class="calendar-section" id="calendarSection">
            <div class="calendar-header" id="calendarHeader">
              December, 2025
            </div>
            <div class="calendar-grid">
              <div class="calendar-day-header">Mon</div>
              <div class="calendar-day-header">Tue</div>
              <div class="calendar-day-header">Wed</div>
              <div class="calendar-day-header">Thu</div>
              <div class="calendar-day-header">Fri</div>
              <div class="calendar-day-header">Sat</div>
              <div class="calendar-day-header">Sun</div>
            </div>
            <div class="calendar-days-container" id="calendarDaysContainer">
              <div class="calendar-grid" id="calendarDays"></div>
            </div>
          </div>

          <div class="right-content">
            <!-- 今日目录 -->
            <div class="meals-section">
              <div class="today-section-title">今日目录</div>
              <div class="meals-container">
                <div class="meals-grid" id="todayMeals">
                  <div class="meal-card">
                    <div class="meal-time">暂无记录</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 今日营养概览 -->
            <div class="nutrition-section">
              <div class="today-section-title">今日营养概览</div>
              <div class="nutrition-chart">
                <div class="nutrition-bar" data-nutrition="protein">
                  <div class="nutrition-tooltip" id="proteinTooltip">
                    <div class="tooltip-title">蛋白质</div>
                    <div class="tooltip-item">
                      <span>已摄入:</span>
                      <span class="tooltip-value" id="proteinActual">0g</span>
                    </div>
                    <div class="tooltip-item">
                      <span>推荐量:</span>
                      <span class="tooltip-value">60g</span>
                    </div>
                    <div class="tooltip-percentage" id="proteinPercent">0%</div>
                  </div>
                  <div class="bar-container">
                    <div class="bar" id="proteinBar" style="height: 0%"></div>
                  </div>
                  <div class="bar-label">蛋白质</div>
                </div>
                <div class="nutrition-bar" data-nutrition="carbs">
                  <div class="nutrition-tooltip" id="carbsTooltip">
                    <div class="tooltip-title">碳水化合物</div>
                    <div class="tooltip-item">
                      <span>已摄入:</span>
                      <span class="tooltip-value" id="carbsActual">0g</span>
                    </div>
                    <div class="tooltip-item">
                      <span>推荐量:</span>
                      <span class="tooltip-value">300g</span>
                    </div>
                    <div class="tooltip-percentage" id="carbsPercent">0%</div>
                  </div>
                  <div class="bar-container">
                    <div class="bar" id="carbsBar" style="height: 0%"></div>
                  </div>
                  <div class="bar-label">碳水化合物</div>
                </div>
                <div class="nutrition-bar" data-nutrition="vitamin">
                  <div class="nutrition-tooltip" id="vitaminTooltip">
                    <div class="tooltip-title">维生素</div>
                    <div class="tooltip-item">
                      <span>已摄入:</span>
                      <span class="tooltip-value" id="vitaminActual">0g</span>
                    </div>
                    <div class="tooltip-item">
                      <span>推荐量:</span>
                      <span class="tooltip-value">25g</span>
                    </div>
                    <div class="tooltip-percentage" id="vitaminPercent">0%</div>
                  </div>
                  <div class="bar-container">
                    <div
                      class="bar light"
                      id="vitaminBar"
                      style="height: 0%"
                    ></div>
                  </div>
                  <div class="bar-label">维生素</div>
                </div>
                <div class="nutrition-bar" data-nutrition="fat">
                  <div class="nutrition-tooltip" id="fatTooltip">
                    <div class="tooltip-title">脂肪</div>
                    <div class="tooltip-item">
                      <span>已摄入:</span>
                      <span class="tooltip-value" id="fatActual">0g</span>
                    </div>
                    <div class="tooltip-item">
                      <span>推荐量:</span>
                      <span class="tooltip-value">60g</span>
                    </div>
                    <div class="tooltip-percentage" id="fatPercent">0%</div>
                  </div>
                  <div class="bar-container">
                    <div class="bar" id="fatBar" style="height: 0%"></div>
                  </div>
                  <div class="bar-label">脂肪</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 推荐食物 -->
        <!-- <div class="recommendations-section">
          <div class="today-section-title">推荐食物</div>
          <table class="food-table">
            <thead>
              <tr>
                <th></th>
                <th>Vegetable</th>
                <th>Protein</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Juicy Apple</td>
                <td>Fresh Salad</td>
                <td>Lean Chicken</td>
              </tr>
              <tr>
                <td>120 cal per 100g</td>
                <td>150 cal per serving</td>
                <td>165 cal per serving</td>
              </tr>
              <tr>
                <td>Salad</td>
                <td>Chicken Breast</td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div> -->
      </div>
    </div>

    <!-- 食物详情模态框 -->
    <div class="food-detail-modal" id="foodDetailModal">
      <div class="food-detail-content">
        <button class="food-detail-close" onclick="closeFoodDetail()">×</button>
        <div class="food-detail-image" id="foodDetailImage"></div>
        <div class="food-detail-body">
          <h2 class="food-detail-title" id="foodDetailTitle">食物名称</h2>
          <div class="food-detail-time" id="foodDetailTime">
            2025年12月25日 11:35
          </div>

          <div class="weight-info">
            <div class="weight-value" id="foodDetailWeight">0g</div>
            <div class="weight-label">估计重量</div>
          </div>

          <div class="food-detail-section">
            <div class="food-detail-section-title">食物描述</div>
            <div class="food-detail-description" id="foodDetailDescription">
              暂无描述信息
            </div>
          </div>

          <div class="food-detail-section">
            <div class="food-detail-section-title">营养成分 (总量)</div>
            <div class="nutrition-grid">
              <div class="nutrition-item">
                <span class="nutrition-label">蛋白质</span>
                <span class="nutrition-value" id="detailProtein">0g</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-label">碳水化合物</span>
                <span class="nutrition-value" id="detailCarbs">0g</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-label">脂肪</span>
                <span class="nutrition-value" id="detailFat">0g</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-label">热量</span>
                <span class="nutrition-value" id="detailCalories">0 kcal</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-label">膳食纤维</span>
                <span class="nutrition-value" id="detailFiber">0g</span>
              </div>
              <div class="nutrition-item">
                <span class="nutrition-label">钠</span>
                <span class="nutrition-value" id="detailSodium">0mg</span>
              </div>
            </div>
          </div>

          <div class="food-detail-section">
            <div class="food-detail-section-title">维生素</div>
            <div class="vitamins-list" id="foodDetailVitamins">
              <span class="vitamin-tag">暂无数据</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE_URL =
        //"http://localhost:8001";
        "https://api.food-monitor.0nlinetech.littlemaster.fun";
      let currentDate = new Date();
      let selectedDate = new Date();
      let calendarExpanded = false;

      // 页面加载时初始化
      document.addEventListener("DOMContentLoaded", () => {
        renderCalendar();
        loadTodayData();
        setupCalendarToggle();
        setupNutritionTooltips();
        // 每30秒自动刷新一次
        setInterval(loadTodayData, 30000);
      });

      // 设置营养详情气泡
      function setupNutritionTooltips() {
        const nutritionBars = document.querySelectorAll(".nutrition-bar");
        let activeTooltip = null;

        nutritionBars.forEach((bar) => {
          bar.addEventListener("click", (e) => {
            const tooltip = bar.querySelector(".nutrition-tooltip");

            // 如果点击的是已激活的气泡，关闭它
            if (
              activeTooltip === tooltip &&
              tooltip.classList.contains("show")
            ) {
              tooltip.classList.remove("show");
              activeTooltip = null;
            } else {
              // 关闭其他气泡
              if (activeTooltip) {
                activeTooltip.classList.remove("show");
              }
              // 显示当前气泡
              tooltip.classList.add("show");
              activeTooltip = tooltip;
            }
          });
        });

        // 点击其他区域关闭气泡
        document.addEventListener("click", (e) => {
          if (!e.target.closest(".nutrition-bar") && activeTooltip) {
            activeTooltip.classList.remove("show");
            activeTooltip = null;
          }
        });
      }

      // 设置日历折叠/展开功能
      function setupCalendarToggle() {
        const calendarSection = document.getElementById("calendarSection");
        const container = document.getElementById("calendarDaysContainer");

        calendarSection.addEventListener("click", (e) => {
          // 如果点击的是日期，不触发折叠
          if (e.target.classList.contains("calendar-day")) {
            return;
          }

          calendarExpanded = !calendarExpanded;
          if (calendarExpanded) {
            container.classList.add("expanded");
          } else {
            container.classList.remove("expanded");
          }
        });
      }

      // 渲染日历
      function renderCalendar() {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();

        // 更新月份显示
        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        document.getElementById(
          "calendarHeader"
        ).textContent = `${monthNames[month]}, ${year}`;

        // 获取月份第一天和最后一天
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();

        // 获取第一天是星期几 (0=Sunday, 调整为 0=Monday)
        let firstDayOfWeek = firstDay.getDay();
        firstDayOfWeek = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;

        const calendarDays = document.getElementById("calendarDays");
        calendarDays.innerHTML = "";

        // 填充上个月的日期
        const prevMonthDays = new Date(year, month, 0).getDate();
        for (let i = firstDayOfWeek - 1; i >= 0; i--) {
          const day = document.createElement("div");
          day.className = "calendar-day disabled";
          day.textContent = prevMonthDays - i;
          calendarDays.appendChild(day);
        }

        // 填充本月日期
        const today = new Date();
        today.setHours(0, 0, 0, 0); // 重置时间为当天开始

        // 计算30天前的日期
        const thirtyDaysAgo = new Date(today);
        thirtyDaysAgo.setDate(today.getDate() - 30);

        for (let i = 1; i <= daysInMonth; i++) {
          const day = document.createElement("div");
          const currentDay = new Date(year, month, i);
          currentDay.setHours(0, 0, 0, 0);

          day.className = "calendar-day";
          day.textContent = i;

          // 判断日期是否在过去30天内（包括今天）
          const isWithinRange =
            currentDay >= thirtyDaysAgo && currentDay <= today;

          // 标记今天
          if (
            year === today.getFullYear() &&
            month === today.getMonth() &&
            i === today.getDate()
          ) {
            day.classList.add("today");
          }

          // 如果不在范围内，设置为禁用
          if (!isWithinRange) {
            day.classList.add("disabled");
          } else {
            // 只为在范围内的日期添加点击事件
            day.addEventListener("click", () => {
              selectedDate = new Date(year, month, i);
              loadDayData(selectedDate);
            });
          }

          calendarDays.appendChild(day);
        }

        // 填充下个月的日期
        const remainingDays = 42 - (firstDayOfWeek + daysInMonth);
        for (let i = 1; i <= remainingDays; i++) {
          const day = document.createElement("div");
          day.className = "calendar-day disabled";
          day.textContent = i;
          calendarDays.appendChild(day);
        }
      }

      // 加载今日数据
      async function loadTodayData() {
        const today = new Date();
        const dateStr = formatDate(today);
        await loadDayData(today, dateStr);
      }

      // 加载指定日期数据
      async function loadDayData(date, dateStr = null) {
        if (!dateStr) {
          dateStr = formatDate(date);
        }

        try {
          // 获取当天营养数据
          const response = await fetch(
            `${API_BASE_URL}/api/nutrition/daily/${dateStr}`
          );
          const data = await response.json();

          if (data.status === "success") {
            // 更新今日目录
            updateTodayMeals(data.foods || []);

            // 更新营养图表
            updateNutritionChart(data.total_nutrition || {});
          }
        } catch (error) {
          console.error("加载数据失败:", error);
        }
      }

      // 显示食物详情
      async function showFoodDetail(meal) {
        const modal = document.getElementById("foodDetailModal");
        const imageUrl = `${API_BASE_URL}/api/image/${meal.filename}`;

        // 显示模态框（先显示加载状态）
        modal.classList.add("show");

        try {
          // 调用metadata接口获取完整的详细数据
          const response = await fetch(
            `${API_BASE_URL}/api/image/${meal.filename}/metadata`
          );
          const data = await response.json();

          if (data.status === "success") {
            const metadata = data.metadata;
            const uploadTime = new Date(metadata.upload_time);
            const foodRec = metadata.food_recognition || {};

            // 设置图片
            document.getElementById(
              "foodDetailImage"
            ).style.backgroundImage = `url(${imageUrl})`;

            // 设置基本信息
            document.getElementById("foodDetailTitle").textContent =
              foodRec.food_name || "未识别";
            document.getElementById(
              "foodDetailTime"
            ).textContent = `${uploadTime.getFullYear()}年${
              uploadTime.getMonth() + 1
            }月${uploadTime.getDate()}日 ${uploadTime.toLocaleTimeString(
              "zh-CN",
              {
                hour: "2-digit",
                minute: "2-digit",
              }
            )}`;

            // 设置重量
            document.getElementById("foodDetailWeight").textContent =
              (foodRec.estimated_weight || 0).toFixed(0) + "g";

            // 设置描述
            document.getElementById("foodDetailDescription").textContent =
              foodRec.description || "暂无描述信息";

            // 设置营养成分（总量）
            const totalNutrition = foodRec.total_nutrition || {};
            document.getElementById("detailProtein").textContent =
              (totalNutrition.protein || 0).toFixed(1) + "g";
            document.getElementById("detailCarbs").textContent =
              (totalNutrition.carbohydrates || 0).toFixed(1) + "g";
            document.getElementById("detailFat").textContent =
              (totalNutrition.fat || 0).toFixed(1) + "g";
            document.getElementById("detailCalories").textContent =
              (totalNutrition.calories || 0).toFixed(0) + " kcal";
            document.getElementById("detailFiber").textContent =
              (totalNutrition.fiber || 0).toFixed(1) + "g";
            document.getElementById("detailSodium").textContent =
              (totalNutrition.sodium || 0).toFixed(0) + "mg";

            // 设置维生素
            const vitamins = foodRec.vitamins || [];
            const vitaminsContainer =
              document.getElementById("foodDetailVitamins");
            if (vitamins.length > 0) {
              vitaminsContainer.innerHTML = vitamins
                .map((v) => `<span class="vitamin-tag">${v}</span>`)
                .join("");
            } else {
              vitaminsContainer.innerHTML =
                '<span class="vitamin-tag">暂无数据</span>';
            }
          } else {
            // 如果接口返回失败，显示错误信息
            document.getElementById("foodDetailTitle").textContent =
              "获取详情失败";
            document.getElementById("foodDetailDescription").textContent =
              data.detail || "无法获取食物详细信息";
          }
        } catch (error) {
          console.error("获取食物详情失败:", error);
          document.getElementById("foodDetailTitle").textContent = "加载失败";
          document.getElementById("foodDetailDescription").textContent =
            "网络错误，请稍后重试";
        }
      }

      // 关闭食物详情
      function closeFoodDetail() {
        const modal = document.getElementById("foodDetailModal");
        modal.classList.remove("show");
      }

      // 点击模态框背景关闭
      document.addEventListener("DOMContentLoaded", () => {
        document
          .getElementById("foodDetailModal")
          .addEventListener("click", (e) => {
            if (e.target.id === "foodDetailModal") {
              closeFoodDetail();
            }
          });
      });

      // 更新今日用餐
      function updateTodayMeals(foods) {
        const mealsGrid = document.getElementById("todayMeals");

        if (foods.length === 0) {
          mealsGrid.innerHTML = `
            <div class="meal-card">
              <div class="meal-time">暂无记录</div>
            </div>

          `;
          return;
        }

        mealsGrid.innerHTML = "";

        // 显示所有用餐记录（可左右滑动）
        foods.forEach((meal) => {
          const imageUrl = `${API_BASE_URL}/api/image/${meal.filename}`;
          const uploadTime = new Date(meal.upload_time);
          const timeStr = uploadTime.toLocaleTimeString("zh-CN", {
            hour: "2-digit",
            minute: "2-digit",
          });

          const mealCard = document.createElement("div");
          mealCard.className = "meal-card has-image";
          mealCard.innerHTML = `
            <div class="meal-card-image" style="background-image: url(${imageUrl})"></div>
            <div class="meal-time">${uploadTime.getFullYear()}年${
            uploadTime.getMonth() + 1
          }月${uploadTime.getDate()}日 ${timeStr}</div>
          `;

          // 添加点击事件显示详情
          mealCard.addEventListener("click", () => {
            showFoodDetail(meal);
          });

          mealsGrid.appendChild(mealCard);
        });
      }

      // 更新营养图表
      function updateNutritionChart(nutrition) {
        // 设置推荐值（可以根据实际需求调整）
        const recommended = {
          protein: 60, // 60g
          carbohydrates: 300, // 300g
          vitamins: 25, // 假设维生素总值(纤维)
          fat: 60, // 60g
        };

        const proteinValue = nutrition.protein || 0;
        const carbsValue = nutrition.carbohydrates || 0;
        const vitaminValue = nutrition.fiber || 0;
        const fatValue = nutrition.fat || 0;

        // 计算百分比并更新柱状图
        const proteinPercent = Math.min(
          (proteinValue / recommended.protein) * 100,
          100
        );
        const carbsPercent = Math.min(
          (carbsValue / recommended.carbohydrates) * 100,
          100
        );
        const fatPercent = Math.min((fatValue / recommended.fat) * 100, 100);
        const vitaminPercent = Math.min(
          (vitaminValue / recommended.vitamins) * 100,
          100
        );

        // 更新柱状图高度
        document.getElementById("proteinBar").style.height =
          proteinPercent + "%";
        document.getElementById("carbsBar").style.height = carbsPercent + "%";
        document.getElementById("vitaminBar").style.height =
          vitaminPercent + "%";
        document.getElementById("fatBar").style.height = fatPercent + "%";

        // 更新气泡数据
        document.getElementById("proteinActual").textContent =
          proteinValue.toFixed(1) + "g";
        document.getElementById("proteinPercent").textContent =
          Math.round(proteinPercent) + "%";

        document.getElementById("carbsActual").textContent =
          carbsValue.toFixed(1) + "g";
        document.getElementById("carbsPercent").textContent =
          Math.round(carbsPercent) + "%";

        document.getElementById("vitaminActual").textContent =
          vitaminValue.toFixed(1) + "g";
        document.getElementById("vitaminPercent").textContent =
          Math.round(vitaminPercent) + "%";

        document.getElementById("fatActual").textContent =
          fatValue.toFixed(1) + "g";
        document.getElementById("fatPercent").textContent =
          Math.round(fatPercent) + "%";
      }

      // 格式化日期为 YYYY-MM-DD
      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        return `${year}-${month}-${day}`;
      }
    </script>
  </body>
</html>
